<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODAK Event Management System</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container event-selector">
        <div class="selector-header">
            <h1>TODAK Event Management System</h1>
            <p>Select an event to continue</p>
        </div>

        <div class="header-controls">
            <button onclick="toggleTheme()" class="btn-secondary" id="themeToggleBtn">
                <span class="icon" id="themeIcon">ğŸŒ™</span>
                <span id="themeText">Dark Mode</span>
            </button>
            <a href="admin-dashboard.html" class="btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z" />
                    <path d="M2 17l10 5 10-5" />
                    <path d="M2 12l10 5 10-5" />
                </svg>
                Admin Dashboard
            </a>
        </div>

        <div id="eventsContainer">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading events...</p>
            </div>
        </div>
    </div>

    <script>
        // Load theme
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeUI();

        // Toggle theme function
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeUI();
        }

        // Update theme toggle button UI
        function updateThemeUI() {
            const theme = document.documentElement.getAttribute('data-theme');
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            
            if (icon && text) {
                if (theme === 'dark') {
                    icon.textContent = 'ğŸŒ™';
                    text.textContent = 'Dark Mode';
                } else {
                    icon.textContent = 'â˜€ï¸';
                    text.textContent = 'Light Mode';
                }
            }
        }

        // Load active events
        async function loadEvents() {
            try {
                const response = await fetch('/api/get-events');
                const result = await response.json();

                if (result.success) {
                    const activeEvents = result.events.filter(e => e.isActive);

                    if (activeEvents.length === 0) {
                        showNoEvents();
                    } else if (activeEvents.length === 1) {
                        // If only one active event, show it prominently
                        displaySingleEvent(activeEvents[0]);
                    } else {
                        // Multiple events, show grid
                        displayMultipleEvents(activeEvents);
                    }
                } else {
                    showError();
                }
            } catch (error) {
                console.error('Error loading events:', error);
                showError();
            }
        }

        // Generate event icon HTML
        function getEventIcon(event) {
            if (event.cardIconUrl) {
                return `<img src="${event.cardIconUrl}" alt="${event.name}" onerror="this.parentElement.innerHTML='ğŸ‰'">`;
            }
            
            // Default icons based on type or name
            const name = (event.name || '').toLowerCase();
            const type = (event.eventType || '').toLowerCase();
            
            if (name.includes('dinner') || type.includes('dinner')) return 'ğŸ½ï¸';
            if (name.includes('townhall') || type.includes('townhall')) return 'ğŸ“¢';
            if (name.includes('meeting') || type.includes('meeting')) return 'ğŸ¤';
            if (name.includes('party') || type.includes('party')) return 'ğŸ‰';
            if (name.includes('hackathon') || type.includes('hackathon')) return 'ğŸ’»';
            if (name.includes('workshop') || type.includes('workshop')) return 'ğŸ› ï¸';
            if (name.includes('sport') || type.includes('sport')) return 'ğŸ†';
            
            return 'ğŸ‰';
        }

        // Get card background style
        function getCardStyle(event) {
            if (event.cardBackgroundUrl) {
                return `background-image: url('${event.cardBackgroundUrl}');`;
            }
            return '';
        }

        // Get card class
        function getCardClass(event) {
            return event.cardBackgroundUrl ? 'event-card has-background' : 'event-card';
        }

        function displaySingleEvent(event) {
            const container = document.getElementById('eventsContainer');
            const features = event.features || {};
            const showLuckyDraw = features.lucky_draw === true || features.luckyDraw === true;
            const showTrivia = features.trivia === true;
            const showTables = features.tables === true;
            
            container.innerHTML = `
                <div class="events-grid">
                    <div class="${getCardClass(event)}" style="${getCardStyle(event)}" onclick="showEventDetails(${event.id})">
                        <div class="event-icon">${getEventIcon(event)}</div>
                        <div class="event-content">
                            <div class="event-title">${event.name}</div>
                            <div class="event-tagline">${event.theme || 'Welcome to our event'}</div>
                            <div class="event-details">
                                <div>ğŸ“… ${formatDate(event.date)}</div>
                                ${event.venue ? `<div>ğŸ“ ${event.venue}</div>` : ''}
                                ${event.timeStart ? `<div>â° ${formatTime(event.timeStart)} - ${formatTime(event.timeEnd)}</div>` : ''}
                            </div>
                        </div>
                        <div class="event-actions" onclick="event.stopPropagation()">
                            ${features.attendance !== false ? `<a href="checkin.html?event=${event.id}" class="event-btn btn-primary-action">ğŸ“± Check-in</a>` : ''}
                            ${features.attendance !== false ? `<a href="qr-display.html?event=${event.id}" target="_blank" class="event-btn btn-secondary-action">ğŸ“± Show QR</a>` : ''}
                            ${showLuckyDraw ? `<a href="lucky-draw-public.html?event=${event.id}" class="event-btn btn-secondary-action">ğŸ° Lucky Draw</a>` : ''}
                            ${showTrivia ? `<a href="trivia.html?event=${event.id}" class="event-btn btn-secondary-action">ğŸ§  Trivia</a>` : ''}
                            ${showTables ? `<a href="my-table.html?event=${event.id}" class="event-btn btn-secondary-action">ğŸª‘ My Table</a>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function displayMultipleEvents(events) {
            const container = document.getElementById('eventsContainer');
            const eventsHTML = events.map(event => {
                const features = event.features || {};
                const showLuckyDraw = features.lucky_draw === true || features.luckyDraw === true;
                const showTrivia = features.trivia === true;
                const showTables = features.tables === true;
                
                return `
                <div class="${getCardClass(event)}" style="${getCardStyle(event)}" onclick="showEventDetails(${event.id})">
                    <div class="event-icon">${getEventIcon(event)}</div>
                    <div class="event-content">
                        <div class="event-title">${event.name}</div>
                        <div class="event-tagline">${event.theme || 'Welcome to our event'}</div>
                        <div class="event-details">
                            <div>ğŸ“… ${formatDate(event.date)}</div>
                            ${event.venue ? `<div>ğŸ“ ${event.venue}</div>` : ''}
                            ${event.timeStart ? `<div>â° ${formatTime(event.timeStart)} - ${formatTime(event.timeEnd)}</div>` : ''}
                        </div>
                    </div>
                    <div class="event-actions" onclick="event.stopPropagation()">
                        ${features.attendance !== false ? `<a href="checkin.html?event=${event.id}" class="event-btn btn-primary-action">ğŸ“± Check-in</a>` : ''}
                        ${features.attendance !== false ? `<a href="qr-display.html?event=${event.id}" target="_blank" class="event-btn btn-secondary-action">ğŸ“± Show QR</a>` : ''}
                        ${showLuckyDraw ? `<a href="lucky-draw-public.html?event=${event.id}" class="event-btn btn-secondary-action">ğŸ° Lucky Draw</a>` : ''}
                        ${showTrivia ? `<a href="trivia.html?event=${event.id}" class="event-btn btn-secondary-action">ğŸ§  Trivia</a>` : ''}
                        ${showTables ? `<a href="my-table.html?event=${event.id}" class="event-btn btn-secondary-action">ğŸª‘ My Table</a>` : ''}
                    </div>
                </div>
            `}).join('');

            container.innerHTML = `<div class="events-grid">${eventsHTML}</div>`;
        }

        function showNoEvents() {
            const container = document.getElementById('eventsContainer');
            container.innerHTML = `
                <div class="loading">
                    <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ“…</div>
                    <p>No active events at the moment</p>
                    <p style="margin-top: 20px;">
                        <a href="admin-dashboard.html" style="color: var(--primary-color);">Go to Admin Dashboard</a>
                    </p>
                </div>
            `;
        }

        function showError() {
            const container = document.getElementById('eventsContainer');
            container.innerHTML = `
                <div class="loading">
                    <div style="font-size: 4rem; margin-bottom: 20px;">âš ï¸</div>
                    <p>Failed to load events</p>
                    <p style="margin-top: 20px;">
                        <a href="admin-dashboard.html" style="color: var(--primary-color);">Go to Admin Dashboard</a>
                    </p>
                </div>
            `;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Date TBA';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatTime(timeString) {
            if (!timeString) return '';
            return timeString.substring(0, 5);
        }

        // Show event details modal
        async function showEventDetails(eventId) {
            try {
                const response = await fetch(`/api/get-event?id=${eventId}`);
                const result = await response.json();

                if (result.success && result.event) {
                    const event = result.event;
                    const modal = createEventDetailsModal(event);
                    document.body.appendChild(modal);
                    modal.style.display = 'flex';
                } else {
                    alert('Failed to load event details');
                }
            } catch (error) {
                console.error('Error loading event details:', error);
                alert('Failed to load event details');
            }
        }

        // Create event details modal
        function createEventDetailsModal(event) {
            const modal = document.createElement('div');
            modal.className = 'event-details-modal';
            modal.innerHTML = `
                <div class="modal-backdrop" onclick="closeEventDetailsModal(this)"></div>
                <div class="modal-content-event">
                    <div class="modal-header-event">
                        <h2>${event.name || 'Event Details'}</h2>
                        <button class="close-btn-event" onclick="closeEventDetailsModal(this.closest('.event-details-modal'))">&times;</button>
                    </div>
                    <div class="modal-body-event">
                        <div class="event-detail-section">
                            <h3>ğŸ“… Date & Time</h3>
                            <p>${formatDate(event.date)}</p>
                            ${event.timeStart ? `<p>â° ${formatTime(event.timeStart)} - ${formatTime(event.timeEnd)}</p>` : ''}
                        </div>
                        ${event.venue ? `
                        <div class="event-detail-section">
                            <h3>ğŸ“ Venue</h3>
                            <p>${event.venue}</p>
                        </div>
                        ` : ''}
                        ${event.theme ? `
                        <div class="event-detail-section">
                            <h3>ğŸ­ Theme</h3>
                            <p>${event.theme}</p>
                        </div>
                        ` : ''}
                        ${event.tentative ? `
                        <div class="event-detail-section">
                            <h3>ğŸ“‹ Event Program</h3>
                            <div class="event-program">${event.tentative.replace(/\n/g, '<br>')}</div>
                        </div>
                        ` : ''}
                        ${event.menu ? `
                        <div class="event-detail-section">
                            <h3>ğŸ½ï¸ Menu</h3>
                            <div class="event-menu">${event.menu.replace(/\n/g, '<br>')}</div>
                        </div>
                        ` : ''}
                        <div class="event-detail-section">
                            <h3>ğŸ¯ Available Features</h3>
                            <div class="features-list">
                                ${event.features?.attendance !== false ? '<span class="feature-badge">ğŸ“± Check-in</span>' : ''}
                                ${event.features?.tables ? '<span class="feature-badge">ğŸª‘ Table Assignment</span>' : ''}
                                ${event.features?.lucky_draw || event.features?.luckyDraw ? '<span class="feature-badge">ğŸ° Lucky Draw</span>' : ''}
                                ${event.features?.trivia ? '<span class="feature-badge">ğŸ§  Trivia Challenge</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer-event">
                        <button onclick="closeEventDetailsModal(this.closest('.event-details-modal'))" class="btn-secondary">Close</button>
                    </div>
                </div>
            `;
            return modal;
        }

        function closeEventDetailsModal(modal) {
            if (modal) {
                modal.style.display = 'none';
                setTimeout(() => modal.remove(), 300);
            }
        }

        // Load events on page load
        loadEvents();
    </script>

    <style>
        .event-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .event-actions {
            pointer-events: auto;
        }

        .event-actions a {
            pointer-events: auto;
        }

        .event-details-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
        }

        .modal-backdrop {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            cursor: pointer;
        }

        .modal-content-event {
            position: relative;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1001;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header-event {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 30px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header-event h2 {
            margin: 0;
            color: var(--primary-color);
        }

        .close-btn-event {
            background: transparent;
            border: none;
            font-size: 2rem;
            color: var(--text-secondary);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn-event:hover {
            background: var(--dark-bg);
            color: var(--primary-color);
        }

        .modal-body-event {
            padding: 30px;
        }

        .event-detail-section {
            margin-bottom: 30px;
        }

        .event-detail-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .event-detail-section p {
            color: var(--text-primary);
            margin: 8px 0;
            line-height: 1.6;
        }

        .event-program,
        .event-menu {
            background: var(--dark-bg);
            padding: 20px;
            border-radius: 10px;
            color: var(--text-primary);
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .features-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .feature-badge {
            display: inline-block;
            padding: 8px 16px;
            background: var(--dark-bg);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .modal-footer-event {
            padding: 20px 30px;
            border-top: 2px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
        }

        @media (max-width: 768px) {
            .modal-content-event {
                width: 95%;
                max-height: 95vh;
            }

            .modal-header-event,
            .modal-body-event,
            .modal-footer-event {
                padding: 20px;
            }
        }
    </style>
</body>

</html>